# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository packages developer tools as [Dev Container Features](https://containers.dev/implementors/features/). Features are self-contained units of installation code and configuration that can be added to devcontainers. Current features: `claude-code`, `uv`, `mise`. Features are published to the GitHub Container Registry on pushes to `main`.

## Development Commands

Requires `@devcontainers/cli` installed globally: `npm install -g @devcontainers/cli`

### Run tests

All tests for a specific feature (replace `<feature>` with `claude-code`, `uv`, `mise`, etc.):
```
devcontainer features test -f <feature>
```

Autogenerated tests only (smoke tests across base images, no scenarios):
```
devcontainer features test --skip-scenarios -f <feature> -i ubuntu:latest
```

Scenario tests only:
```
devcontainer features test -f <feature> --skip-autogenerated --skip-duplicated
```

Global scenario tests:
```
devcontainer features test --global-scenarios-only
```

## Architecture

Each feature lives under `src/<feature-name>/` with two required files:
- `devcontainer-feature.json` — metadata, options, VS Code extensions, mounts, install ordering
- `install.sh` — shell script executed during container build

Tests live under `test/<feature-name>/`:
- `scenarios.json` — defines named test scenarios, each specifying a base image and feature options
- `test.sh` — scenario test script using the `dev-container-features-test-lib` framework (`check` assertions + `reportResults`)
- `basic.sh` — standalone smoke test (plain bash, no test framework)

The release workflow (`release.yaml`) auto-generates `README.md` files for each feature via `devcontainers/action` and opens a PR with the generated docs.

## Conventions

- Install scripts use `/bin/sh` (not bash) for broader compatibility
- Install scripts should be idempotent (check if already installed before re-installing)
- Feature JSON uses `installsAfter` to declare ordering dependencies on other features
- The `mounts` field in feature JSON creates persistent volumes for configuration that should survive container rebuilds
- Install scripts handle curl installation across package managers (apt-get, apk, dnf, yum)
- When installing as root for a non-root user, use `su - "${USERNAME}" -c "..."` to run the installer
- Symlink binaries into `/usr/local/bin/` so they're on PATH in non-login shells
- `containerEnv.PATH` in feature JSON should include all directories needed for the tool and its managed binaries (e.g., shims directories)

## Gotchas

### Volume mount ownership
Docker volume mounts create directories as root — both the target **and all intermediate parent directories**. This happens at container start, after the image is built, so any `chown` in `install.sh` is overwritten. Fix ownership via `postAttachCommand` in `devcontainer-feature.json`, which runs after mounts are applied. The command must:
1. Guard against bare images with no `vscode` user: `id vscode >/dev/null 2>&1`
2. Chown parent directories too (e.g., `/home/vscode/.local/share`), not just the mount target
3. Use `sudo` since the command runs as the remote user

### Publishing new versions
The `devcontainers/action` in `release.yaml` only publishes to GHCR when the `version` field in `devcontainer-feature.json` changes. Pushing code fixes without bumping the version will **not** update the published package. Always bump the version when making changes that need to be published.

### Testing with local features
To test a local feature with `devcontainer up`, copy the feature directory into the workspace's `.devcontainer/` folder and reference it with `./feature-name` in `devcontainer.json`. Absolute paths are not supported by the CLI. The `devcontainer features test` framework handles local features automatically via `./` references.

### Test runner limitations
- Running multiple `devcontainer features test` commands in parallel can cause Docker resource contention and flaky failures. Run sequentially for reliable results.
- `devcontainer up` does not run `postAttachCommand` unless using `--skip-post-attach=false` (it runs by default but may not in all CLI versions). Always verify with `devcontainer exec` after `up`.
